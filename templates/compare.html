{% extends 'base.html' %}
{% load static %}

{% block title %}–°—Ä–∞–≤–Ω–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã | Edu Hub{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/pages/compare.css' %}">
{% endblock %}

{% block content %}
<!-- Compare Header -->
<section class="compare-hero">
    <div class="container">
        <div class="compare-header">
            <div class="section-label">AI –ü–æ–º–æ—â–Ω–∏–∫</div>
            <h1>–ü–æ–º–æ–≥—É —Å—Ä–∞–≤–Ω–∏—Ç—å <span>—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã</span></h1>
            <p>–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –∏ —è –ø–æ–º–æ–≥—É –≤—ã–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—É–∑ –¥–ª—è —Ç–µ–±—è üéì</p>
        </div>
    </div>
</section>

<!-- AI Compare Chat -->
<section class="compare-section">
    <div class="container">
        <div class="compare-layout">
            <!-- Chat Interface -->
            <div class="compare-chat-container">
                <div class="chat-header">
                    <div class="ai-avatar">ü§ñ</div>
                    <div class="ai-info">
                        <h3>Edu Hub AI</h3>
                        <span class="ai-status">‚óè –û–Ω–ª–∞–π–Ω</span>
                    </div>
                </div>
                
                <div class="chat-messages" id="compareChatMessages">
                    <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                    <div class="message ai-message">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <p>üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî Edu Hub AI, —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –≤—ã–±–æ—Ä–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞.</p>
                            <p>–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ:</p>
                            <ul>
                                <li>‚úÖ –°—Ä–∞–≤–Ω–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º</li>
                                <li>‚úÖ –£–∑–Ω–∞—Ç—å –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã –∫–∞–∂–¥–æ–≥–æ –≤—É–∑–∞</li>
                                <li>‚úÖ –ü–æ–¥–æ–±—Ä–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ø–æ–¥ —Ç–≤–æ–∏ —Ü–µ–ª–∏</li>
                                <li>‚úÖ –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö, —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞—Ö</li>
                            </ul>
                            <p><strong>–ù–∞—á–Ω—ë–º?</strong> –ù–∞–ø–∏—à–∏, –∫–∞–∫–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã —Ö–æ—á–µ—à—å —Å—Ä–∞–≤–Ω–∏—Ç—å, –∏–ª–∏ —Å–ø—Ä–æ—Å–∏ —á—Ç–æ —É–≥–æ–¥–Ω–æ! üòä</p>
                            <p class="hint">–ù–∞–ø—Ä–∏–º–µ—Ä: <em>"–°—Ä–∞–≤–Ω–∏ –ö–∞–∑–ù–£ –∏ –ù–∞–∑–∞—Ä–±–∞–µ–≤ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç"</em> –∏–ª–∏ <em>"–ö–∞–∫–æ–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ª—É—á—à–µ –¥–ª—è IT?"</em></p>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea 
                        id="compareMessageInput" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ä–∞–≤–Ω–∏ –ö–ë–¢–£ –∏ –ú–£–ò–¢ –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞..."
                        rows="1"
                    ></textarea>
                    <button id="compareSendBtn" class="send-btn">
                        <span class="send-icon">‚û§</span>
                    </button>
                </div>
            </div>
            
            <!-- Quick Compare Panel -->
            <div class="quick-compare-panel">
                <h3>üéØ –ë—ã—Å—Ç—Ä–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</h3>
                <p>–í—ã–±–µ—Ä–∏ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</p>
                
                <div class="university-checkboxes">
                    <label class="uni-checkbox">
                        <input type="checkbox" value="turan" data-name="–¢—É—Ä–∞–Ω">
                        <span>üèõÔ∏è –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –¢—É—Ä–∞–Ω</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="kaznu" data-name="–ö–∞–∑–ù–£">
                        <span>üèõÔ∏è –ö–∞–∑–ù–£ –∏–º. –∞–ª—å-–§–∞—Ä–∞–±–∏</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="kbtu" data-name="–ö–ë–¢–£">
                        <span>üíª –ö–ë–¢–£</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="nu" data-name="–ù–∞–∑–∞—Ä–±–∞–µ–≤ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç">
                        <span>üéì –ù–∞–∑–∞—Ä–±–∞–µ–≤ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="sdu" data-name="SDU">
                        <span>üåê SDU</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="narxoz" data-name="–ù–∞—Ä—Ö–æ–∑">
                        <span>üíº –ù–∞—Ä—Ö–æ–∑ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="iitu" data-name="–ú–£–ò–¢">
                        <span>üíª –ú–£–ò–¢</span>
                    </label>
                </div>
                
                <button id="quickCompareBtn" class="quick-compare-btn" disabled>
                    –°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
                
                <div class="comparison-hints">
                    <h4>üí° –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</h4>
                    <button class="hint-btn" data-question="–ö–∞–∫–æ–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –ª—É—á—à–µ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è IT?">IT –∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                    <button class="hint-btn" data-question="–°—Ä–∞–≤–Ω–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –≤ –ö–∞–∑–ù–£, –ö–ë–¢–£ –∏ –ù–∞–∑–∞—Ä–±–∞–µ–≤ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è</button>
                    <button class="hint-btn" data-question="–ì–¥–µ –ª—É—á—à–µ –∏–∑—É—á–∞—Ç—å –±–∏–∑–Ω–µ—Å –∏ —ç–∫–æ–Ω–æ–º–∏–∫—É?">–ë–∏–∑–Ω–µ—Å –∏ —ç–∫–æ–Ω–æ–º–∏–∫–∞</button>
                    <button class="hint-btn" data-question="–ö–∞–∫–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –∏–º–µ—é—Ç –æ–±—â–µ–∂–∏—Ç–∏—è –∏ —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç?">–û–±—â–µ–∂–∏—Ç–∏—è</button>
                    <button class="hint-btn" data-question="–†–∞—Å—Å–∫–∞–∂–∏ –æ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö –æ–±–º–µ–Ω–∞">–û–±–º–µ–Ω –∑–∞ —Ä—É–±–µ–∂</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// –ê–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ textarea
const textarea = document.getElementById('compareMessageInput');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è API
let conversationHistory = [];

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
async function sendCompareMessage(message) {
    if (!message.trim()) return;
    
    const messagesContainer = document.getElementById('compareChatMessages');
    const sendBtn = document.getElementById('compareSendBtn');
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    textarea.value = '';
    textarea.style.height = 'auto';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message ai-message loading';
    loadingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    sendBtn.disabled = true;
    
    try {
        conversationHistory.push({
            role: 'user',
            parts: [{ text: message }]
        });
        
        const response = await fetch('/ai-compare/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                history: conversationHistory
            })
        });
        
        const data = await response.json();
        messagesContainer.removeChild(loadingDiv);
        
        if (data.response) {
            addMessage(data.response, 'ai');
            conversationHistory.push({
                role: 'model',
                parts: [{ text: data.response }]
            });
        } else {
            addMessage('–ò–∑–≤–∏–Ω–∏, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑! üòÖ', 'ai');
        }
    } catch (error) {
        messagesContainer.removeChild(loadingDiv);
        addMessage('–ù–µ –º–æ–≥—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç! üåê', 'ai');
    }
    
    sendBtn.disabled = false;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessage(text, type) {
    const messagesContainer = document.getElementById('compareChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    if (type === 'ai') {
        messageDiv.innerHTML = `
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">${formatMessage(text)}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">${escapeHtml(text)}</div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç AI
function formatMessage(text) {
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º markdown –≤ HTML
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/\n/g, '<br>');
    return text;
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏
document.getElementById('compareSendBtn').addEventListener('click', () => {
    sendCompareMessage(textarea.value);
});

textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendCompareMessage(textarea.value);
    }
});

// –ë—ã—Å—Ç—Ä–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
const checkboxes = document.querySelectorAll('.uni-checkbox input');
const quickCompareBtn = document.getElementById('quickCompareBtn');

checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
        const checkedCount = document.querySelectorAll('.uni-checkbox input:checked').length;
        quickCompareBtn.disabled = checkedCount < 2;
        quickCompareBtn.textContent = checkedCount >= 2 ? `–°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${checkedCount})` : '–í—ã–±–µ—Ä–∏ –º–∏–Ω–∏–º—É–º 2';
    });
});

quickCompareBtn.addEventListener('click', () => {
    const selected = Array.from(document.querySelectorAll('.uni-checkbox input:checked'))
        .map(cb => cb.dataset.name);
    
    if (selected.length >= 2) {
        const message = `–°—Ä–∞–≤–Ω–∏ ${selected.join(', ')} –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º: —Å—Ç–æ–∏–º–æ—Å—Ç—å, –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—ã —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã`;
        sendCompareMessage(message);
        
        // –°–Ω–∏–º–∞–µ–º –≥–∞–ª–æ—á–∫–∏
        checkboxes.forEach(cb => cb.checked = false);
        quickCompareBtn.disabled = true;
        quickCompareBtn.textContent = '–°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ';
    }
});

// –ü–æ–¥—Å–∫–∞–∑–∫–∏-–≤–æ–ø—Ä–æ—Å—ã
document.querySelectorAll('.hint-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        sendCompareMessage(question);
    });
});
</script>
{% endblock %}
