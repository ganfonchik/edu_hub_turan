{% extends 'base.html' %}
{% load static %}

{% block title %}Сравнение университетов — Edu Hub{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/comparison.css' %}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="comparison-hero">
    <div class="container">
        <div class="hero-content">
            <span class="hero-badge">Сравнение</span>
            <h1>Сравнение университетов Казахстана</h1>
            <p>Объективный анализ плюсов и минусов топовых вузов страны. Найди идеальный университет для себя!</p>
        </div>
    </div>
</section>

<!-- Comparison Table Section -->
<section class="comparison-section">
    <div class="container">
        <div class="comparison-table-wrapper">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th class="uni-column">Университет</th>
                        <th class="plus-column">Плюсы</th>
                        <th class="minus-column">Минусы</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'kbtu' %}" class="uni-link">
                                <span class="uni-name">КБТУ</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>Сильные IT и инженерные программы</li>
                                <li>Британские стандарты образования</li>
                                <li>100% трудоустройство выпускников</li>
                                <li>Партнёрство с Shell, KPO, Microsoft</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Высокая стоимость обучения (от 2.5 млн)</li>
                                <li>Высокая учебная нагрузка</li>
                                <li>Ограниченные гуманитарные направления</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'nu' %}" class="uni-link">
                                <img src="{% static 'nu_img1.jpeg' %}" alt="Назарбаев Университет" class="uni-logo">
                                <span class="uni-name">Назарбаев Университет</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>Бесплатное обучение для всех!</li>
                                <li>Международные преподаватели из топ-вузов</li>
                                <li>Партнёрство с Duke, Cambridge, UCL</li>
                                <li>Современный кампус мирового уровня</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Очень высокая конкуренция при поступлении</li>
                                <li>Только Астана — далеко от Алматы</li>
                                <li>Интенсивная программа, мало свободного времени</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'iitu' %}" class="uni-link">
                                <img src="{% static 'iitu_logo.png' %}" alt="МУИТ" class="uni-logo">
                                <span class="uni-name">МУИТ (IITU)</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>ТОП-3 IT вузов Казахстана</li>
                                <li>Уникальные лаборатории: 5G, AI Lab</li>
                                <li>Военная кафедра по кибербезопасности</li>
                                <li>90% выпускников работают в IT</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Только IT направления</li>
                                <li>Меньше международных связей</li>
                                <li>Молодой вуз (с 2009 года)</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'sdu' %}" class="uni-link">
                                <span class="uni-name">SDU</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>Сильный IT-факультет</li>
                                <li>Доступные цены (от 1.1 млн)</li>
                                <li>Просторный зелёный кампус</li>
                                <li>Обмены с вузами Турции и Европы</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Кампус в Каскелене — далеко от центра</li>
                                <li>Меньше научных исследований</li>
                                <li>Ограниченный выбор программ</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'kaznu' %}" class="uni-link">
                                <span class="uni-name">КазНУ им. аль-Фараби</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>#1 в Казахстане, топ-200 мира</li>
                                <li>150+ программ на выбор</li>
                                <li>Много бюджетных мест (гранты)</li>
                                <li>Сильная научная база, 15 НИИ</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Большая бюрократия</li>
                                <li>Переполненные группы</li>
                                <li>Устаревшая инфраструктура в некоторых корпусах</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'narxoz' %}" class="uni-link">
                                <img src="{% static 'narxoz_1.webp' %}" alt="Нархоз" class="uni-logo">
                                <span class="uni-name">Нархоз</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>#1 по бизнес-образованию в ЦА</li>
                                <li>Аккредитации ACCA, CIMA, FIBAA</li>
                                <li>90+ вузов-партнёров в 37 странах</li>
                                <li>Лучший кампус и общежития</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Ограниченные технические направления</li>
                                <li>Высокая стоимость (от 1.2 млн)</li>
                                <li>Фокус только на бизнес/экономику</li>
                            </ul>
                        </td>
                    </tr>
                    <tr>
                        <td class="uni-cell">
                            <a href="{% url 'university_detail' 'turan' %}" class="uni-link">
                                <span class="uni-name">Туран</span>
                            </a>
                        </td>
                        <td class="plus-cell">
                            <ul>
                                <li>Творческие и гуманитарные направления</li>
                                <li>Доступная стоимость обучения</li>
                                <li>Международные программы</li>
                                <li>Удобное расположение в центре</li>
                            </ul>
                        </td>
                        <td class="minus-cell">
                            <ul>
                                <li>Меньше технических программ</li>
                                <li>Ограниченные ресурсы для исследований</li>
                                <li>Менее известен за рубежом</li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</section>

<!-- Summary Section -->
<section class="summary-section">
    <div class="container">
        <h2>Краткий вывод</h2>
        <div class="summary-grid">
            <div class="summary-card">
                <h3>Для IT-шников</h3>
                <p><strong>КБТУ, МУИТ, SDU</strong> — лучшие программы по программированию и кибербезопасности</p>
            </div>
            <div class="summary-card">
                <h3>Для бизнеса</h3>
                <p><strong>Нархоз, КБТУ</strong> — топовое бизнес-образование с международными аккредитациями</p>
            </div>
            <div class="summary-card">
                <h3>Бесплатно</h3>
                <p><strong>НУ, КазНУ</strong> — много грантов и бюджетных мест</p>
            </div>
            <div class="summary-card">
                <h3>Для науки</h3>
                <p><strong>КазНУ, НУ</strong> — сильнейшая научная база и исследования</p>
            </div>
        </div>
    </div>
</section>

<!-- AI Compare Section -->
<section class="ai-compare-section">
    <div class="container">
        <div class="ai-section-header">
            <h2>AI Помощник в выборе университета</h2>
            <p>Задавай вопросы, и я помогу выбрать идеальный вуз для тебя</p>
        </div>
        
        <div class="compare-layout">
            <!-- Chat Interface -->
            <div class="compare-chat-container">
                <div class="chat-header">
                    <div class="ai-avatar">AI</div>
                    <div class="ai-info">
                        <h3>Edu Hub AI</h3>
                        <span class="ai-status">Онлайн</span>
                    </div>
                </div>
                
                <div class="chat-messages" id="compareChatMessages">
                    <!-- Приветственное сообщение -->
                    <div class="message ai-message">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                            <p>Привет! Я — Edu Hub AI, твой помощник в выборе университета.</p>
                            <p>Я помогу тебе:</p>
                            <ul>
                                <li>Сравнить университеты по параметрам</li>
                                <li>Узнать плюсы и минусы каждого вуза</li>
                                <li>Подобрать университет под твои цели</li>
                                <li>Рассказать о программах, стоимости, перспективах</li>
                            </ul>
                            <p><strong>Начнём?</strong> Напиши, какие университеты хочешь сравнить, или спроси что угодно!</p>
                            <p class="hint">Например: <em>"Сравни КазНУ и Назарбаев Университет"</em> или <em>"Какой университет лучше для IT?"</em></p>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <textarea 
                        id="compareMessageInput" 
                        placeholder="Например: Сравни КБТУ и МУИТ для программиста..."
                        rows="1"
                    ></textarea>
                    <button id="compareSendBtn" class="send-btn">
                        <span class="send-icon">→</span>
                    </button>
                </div>
            </div>
            
            <!-- Quick Compare Panel -->
            <div class="quick-compare-panel">
                <h3>Быстрое сравнение</h3>
                <p>Выбери университеты для сравнения:</p>
                
                <div class="university-checkboxes">
                    <label class="uni-checkbox">
                        <input type="checkbox" value="turan" data-name="Туран">
                        <span>Университет Туран</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="kaznu" data-name="КазНУ">
                        <span>КазНУ им. аль-Фараби</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="kbtu" data-name="КБТУ">
                        <span>КБТУ</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="nu" data-name="Назарбаев Университет">
                        <span>Назарбаев Университет</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="sdu" data-name="SDU">
                        <span>SDU</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="narxoz" data-name="Нархоз">
                        <span>Нархоз Университет</span>
                    </label>
                    <label class="uni-checkbox">
                        <input type="checkbox" value="iitu" data-name="МУИТ">
                        <span>МУИТ</span>
                    </label>
                </div>
                
                <button id="quickCompareBtn" class="quick-compare-btn" disabled>
                    Сравнить выбранные
                </button>
                
                <div class="comparison-hints">
                    <h4>Популярные вопросы:</h4>
                    <button class="hint-btn" data-question="Какой университет лучше для изучения IT?">IT и программирование</button>
                    <button class="hint-btn" data-question="Сравни стоимость обучения в КазНУ, КБТУ и Назарбаев Университете">Стоимость обучения</button>
                    <button class="hint-btn" data-question="Где лучше изучать бизнес и экономику?">Бизнес и экономика</button>
                    <button class="hint-btn" data-question="Какие университеты имеют общежития и сколько это стоит?">Общежития</button>
                    <button class="hint-btn" data-question="Расскажи о международных программах обмена">Обмен за рубеж</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Авто-расширение textarea
const textarea = document.getElementById('compareMessageInput');
textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// История сообщений для API
let conversationHistory = [];

// Отправка сообщения
async function sendCompareMessage(message) {
    if (!message.trim()) return;
    
    const messagesContainer = document.getElementById('compareChatMessages');
    const sendBtn = document.getElementById('compareSendBtn');
    
    // Добавляем сообщение пользователя
    addMessage(message, 'user');
    textarea.value = '';
    textarea.style.height = 'auto';
    
    // Добавляем индикатор загрузки
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message ai-message loading';
    loadingDiv.innerHTML = `
        <div class="message-avatar">AI</div>
        <div class="message-content">
            <div class="typing-indicator">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    messagesContainer.appendChild(loadingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    sendBtn.disabled = true;
    
    try {
        conversationHistory.push({
            role: 'user',
            parts: [{ text: message }]
        });
        
        const response = await fetch('/ai-compare/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                history: conversationHistory
            })
        });
        
        const data = await response.json();
        messagesContainer.removeChild(loadingDiv);
        
        if (data.response) {
            addMessage(data.response, 'ai');
            conversationHistory.push({
                role: 'model',
                parts: [{ text: data.response }]
            });
        } else {
            addMessage('Извини, произошла ошибка. Попробуй ещё раз!', 'ai');
        }
    } catch (error) {
        messagesContainer.removeChild(loadingDiv);
        addMessage('Не могу подключиться к серверу. Проверь интернет!', 'ai');
    }
    
    sendBtn.disabled = false;
}

// Добавление сообщения в чат
function addMessage(text, type) {
    const messagesContainer = document.getElementById('compareChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}-message`;
    
    if (type === 'ai') {
        messageDiv.innerHTML = `
            <div class="message-avatar">AI</div>
            <div class="message-content">${formatMessage(text)}</div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-content">${escapeHtml(text)}</div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Форматирование сообщений от AI
function formatMessage(text) {
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/\n/g, '<br>');
    return text;
}

// Экранирование HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Обработчик отправки
document.getElementById('compareSendBtn').addEventListener('click', () => {
    sendCompareMessage(textarea.value);
});

textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendCompareMessage(textarea.value);
    }
});

// Быстрое сравнение
const checkboxes = document.querySelectorAll('.uni-checkbox input');
const quickCompareBtn = document.getElementById('quickCompareBtn');

checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
        const checkedCount = document.querySelectorAll('.uni-checkbox input:checked').length;
        quickCompareBtn.disabled = checkedCount < 2;
        quickCompareBtn.textContent = checkedCount >= 2 ? `Сравнить выбранные (${checkedCount})` : 'Выбери минимум 2';
    });
});

quickCompareBtn.addEventListener('click', () => {
    const selected = Array.from(document.querySelectorAll('.uni-checkbox input:checked'))
        .map(cb => cb.dataset.name);
    
    if (selected.length >= 2) {
        const message = `Сравни ${selected.join(', ')} по основным параметрам: стоимость, качество образования, перспективы трудоустройства, международные программы`;
        sendCompareMessage(message);
        
        checkboxes.forEach(cb => cb.checked = false);
        quickCompareBtn.disabled = true;
        quickCompareBtn.textContent = 'Сравнить выбранные';
    }
});

// Подсказки-вопросы
document.querySelectorAll('.hint-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const question = btn.dataset.question;
        sendCompareMessage(question);
    });
});
</script>
{% endblock %}
