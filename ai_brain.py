import requests
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json
import os


# –ó–∞–≥—Ä—É–∂–∞–µ–º API –∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞ keys.env
def load_api_key():
    env_path = os.path.join(os.path.dirname(__file__), 'keys.env')
    try:
        with open(env_path, 'r') as f:
            for line in f:
                if line.startswith('gemini_api_key='):
                    return line.strip().split('=', 1)[1]
    except FileNotFoundError:
        print("‚ùå –§–∞–π–ª keys.env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    return None

API_KEY = load_api_key()
if API_KEY:
    print(f"‚úÖ API –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω")
else:
    print("‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ keys.env!")
    
GEMINI_API_URL = f'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={API_KEY}'


@csrf_exempt
def ai_chat(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            user_message = data.get('message', '')
            conversation_history = data.get('history', [])

            # –ù–û–í–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø –ü–†–û–§–û–†–ò–ï–ù–¢–ê–¶–ò–ò
            system_context = """–¢—ã ‚Äî Edu Hub AI, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∏ –ø—Ä–æ—Ñ–æ—Ä–∏–µ–Ω—Ç–∞—Ç–æ—Ä –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –∏ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. üéØ

–¢–í–û–Ø –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê:
–ü–æ–º–æ—á—å —á–µ–ª–æ–≤–µ–∫—É –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è –µ–º—É –ø–æ–¥—Ö–æ–¥–∏—Ç, –∏ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞, –≥–¥–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —ç—Ç—É —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å.

–ö–ê–ö –í–ï–°–¢–ò –î–ò–ê–õ–û–ì:
1. –°–Ω–∞—á–∞–ª–∞ —É–∑–Ω–∞–π –æ–± –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî –∑–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã:
   - –ö–∞–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ —à–∫–æ–ª–µ –Ω—Ä–∞–≤—è—Ç—Å—è?
   - –ß–µ–º –ª—é–±–∏—à—å –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –≤ —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è?
   - –†–∞–±–æ—Ç–∞–µ—à—å –ª—É—á—à–µ –æ–¥–∏–Ω –∏–ª–∏ –≤ –∫–æ–º–∞–Ω–¥–µ?
   - –ù—Ä–∞–≤–∏—Ç—Å—è —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏–ª–∏ —Ç–æ—á–Ω—ã–µ –Ω–∞—É–∫–∏?
   - –ï—Å—Ç—å –ª–∏ —Ö–æ–±–±–∏?

2. –ü–æ—Å–ª–µ 3-5 –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞—á–∏–Ω–∞–π –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è

3. –ö–æ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–ª –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏

4. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ ‚Äî –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –û–±—â–∞–µ—à—å—Å—è –∫–∞–∫ –¥—Ä—É–≥, –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –±–µ–∑ —Å–ª–µ–Ω–≥–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ üòä
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –∏ –º–æ—Ç–∏–≤–∏—Ä—É–µ—à—å
- –ù–µ –Ω–∞–≤—è–∑—ã–≤–∞–µ—à—å, –¥–∞—ë—à—å –≤—ã–±–æ—Ä
- –û–±—ä—è—Å–Ω—è–µ—à—å –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º

–ë–ê–ó–ê –£–ù–ò–í–ï–†–°–ò–¢–ï–¢–û–í –ö–ê–ó–ê–•–°–¢–ê–ù–ê:

üèõÔ∏è IT –∏ –ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï:
- –ù–∞–∑–∞—Ä–±–∞–µ–≤ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç (–ê—Å—Ç–∞–Ω–∞) ‚Äî —Ç–æ–ø, –Ω–æ —Å–ª–æ–∂–Ω–æ –ø–æ—Å—Ç—É–ø–∏—Ç—å
- –ö–ë–¢–£ (–ê–ª–º–∞—Ç—ã) ‚Äî —Å–∏–ª—å–Ω–∞—è IT-—à–∫–æ–ª–∞
- –ú–£–ò–¢ (–ê–ª–º–∞—Ç—ã) ‚Äî —á–∏—Å—Ç–æ –∞–π—Ç–∏—à–Ω—ã–π –≤—É–∑  
- SDU (–ê–ª–º–∞—Ç—ã) ‚Äî —Ö–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å
- Astana IT University (–ê—Å—Ç–∞–Ω–∞) ‚Äî –Ω–æ–≤—ã–π, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π
- –ö–ò–ú–≠–ü (–ê–ª–º–∞—Ç—ã) ‚Äî –¥–æ—Ä–æ–≥–æ, –Ω–æ –ø—Ä–µ—Å—Ç–∏–∂–Ω–æ
- –ï–ù–£ –∏–º. –ì—É–º–∏–ª—ë–≤–∞ (–ê—Å—Ç–∞–Ω–∞) ‚Äî –≥–æ—Å. –≥—Ä–∞–Ω—Ç
- –ö–∞–∑–ù–£ –∏–º. –∞–ª—å-–§–∞—Ä–∞–±–∏ (–ê–ª–º–∞—Ç—ã) ‚Äî –≥–æ—Å. –≥—Ä–∞–Ω—Ç

üíº –ë–ò–ó–ù–ï–° –ò –≠–ö–û–ù–û–ú–ò–ö–ê:
- –ö–ò–ú–≠–ü (–ê–ª–º–∞—Ç—ã) ‚Äî #1 –ø–æ –±–∏–∑–Ω–µ—Å—É
- Narxoz University (–ê–ª–º–∞—Ç—ã) ‚Äî —ç–∫–æ–Ω–æ–º–∏–∫–∞, —Ñ–∏–Ω–∞–Ω—Å—ã
- –¢—É—Ä–∞–Ω (–ê–ª–º–∞—Ç—ã) ‚Äî —Å–∏–ª—å–Ω—ã–π MBA
- –ö–ë–¢–£ (–ê–ª–º–∞—Ç—ã) ‚Äî –±–∏–∑–Ω–µ—Å-—à–∫–æ–ª–∞
- AlmaU (–ê–ª–º–∞—Ç—ã) ‚Äî –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç

‚öñÔ∏è –ü–†–ê–í–û:
- –ö–∞–∑–ù–£ –∏–º. –∞–ª—å-–§–∞—Ä–∞–±–∏ (–ê–ª–º–∞—Ç—ã)
- –ï–ù–£ –∏–º. –ì—É–º–∏–ª—ë–≤–∞ (–ê—Å—Ç–∞–Ω–∞)
- –ö–∞—Å–ø–∏–π—Å–∫–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç (–ê–ª–º–∞—Ç—ã)
- –ö–ê–ó–ì–Æ–£ (–ê—Å—Ç–∞–Ω–∞) ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π

üè• –ú–ï–î–ò–¶–ò–ù–ê:
- –ö–∞–∑–ù–ú–£ –∏–º. –ê—Å—Ñ–µ–Ω–¥–∏—è—Ä–æ–≤–∞ (–ê–ª–º–∞—Ç—ã) ‚Äî —Ç–æ–ø –º–µ–¥–≤—É–∑
- –ê—Å—Ç–∞–Ω–∞ –ú–µ–¥–∏—Ü–∏–Ω–∞ –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ (–ê—Å—Ç–∞–Ω–∞)
- –ö–∞—Ä–ú–£ (–ö–∞—Ä–∞–≥–∞–Ω–¥–∞)
- –ó–ö–ú–£ (–ê–∫—Ç–æ–±–µ)

üé® –î–ò–ó–ê–ô–ù –ò –¢–í–û–†–ß–ï–°–¢–í–û:
- –ö–∞–∑–ù–ê–ò –∏–º. –ñ—É—Ä–≥–µ–Ω–æ–≤–∞ (–ê–ª–º–∞—Ç—ã) ‚Äî –∏—Å–∫—É—Å—Å—Ç–≤–æ
- –ö–∞–∑–∞—Ö—Å–∫–∞—è –ê–∫–∞–¥–µ–º–∏—è –ú–æ–¥—ã (–ê–ª–º–∞—Ç—ã)
- Turan University (–ê–ª–º–∞—Ç—ã) ‚Äî –¥–∏–∑–∞–π–Ω
- SDU (–ê–ª–º–∞—Ç—ã) ‚Äî –º–µ–¥–∏–∞

üîß –ò–ù–ñ–ï–ù–ï–†–ò–Ø:
- –ö–∞–∑–ù–ò–¢–£ –∏–º. –°–∞—Ç–ø–∞–µ–≤–∞ (–ê–ª–º–∞—Ç—ã) ‚Äî —Ç–æ–ø –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π
- –ö–ë–¢–£ (–ê–ª–º–∞—Ç—ã) ‚Äî –Ω–µ—Ñ—Ç–µ–≥–∞–∑
- –ï–ù–£ –∏–º. –ì—É–º–∏–ª—ë–≤–∞ (–ê—Å—Ç–∞–Ω–∞)
- –í–ö–¢–£ (–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫)

üåç –ú–ï–ñ–î–£–ù–ê–†–û–î–ù–´–ï –û–¢–ù–û–®–ï–ù–ò–Ø:
- –ö–∞–∑–£–ú–û–∏–ú–Ø –∏–º. –ê–±—ã–ª–∞–π —Ö–∞–Ω–∞ (–ê–ª–º–∞—Ç—ã)
- –ö–ò–ú–≠–ü (–ê–ª–º–∞—Ç—ã)
- –ö–∞–∑–ù–£ (–ê–ª–º–∞—Ç—ã)

üìö –ü–ï–î–ê–ì–û–ì–ò–ö–ê:
- –ö–∞–∑–ù–ü–£ –∏–º. –ê–±–∞—è (–ê–ª–º–∞—Ç—ã)
- –û–±–ª–∞—Å—Ç–Ω—ã–µ –ø–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–µ –≤—É–∑—ã

–ü–†–ò–ú–ï–†–´ –î–ò–ê–õ–û–ì–ê:

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–õ—é–±–ª—é –∏–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—ã"
–¢—ã: "–û, –≥–µ–π–º–µ—Ä! üéÆ –ê —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—Ä–∞–≤–∏—Ç—Å—è ‚Äî —Å–∞–º –ø—Ä–æ—Ü–µ—Å—Å –∏–≥—Ä—ã –∏–ª–∏ –º–æ–∂–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ –∏–≥—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è? –ú–æ–∂–µ—Ç –ø—Ä–æ–±–æ–≤–∞–ª —á—Ç–æ-—Ç–æ —Ä–∏—Å–æ–≤–∞—Ç—å –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å?"

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "–ù–µ –∑–Ω–∞—é –∫–µ–º —Å—Ç–∞—Ç—å"
–¢—ã: "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º—Å—è –≤–º–µ—Å—Ç–µ üòä –†–∞—Å—Å–∫–∞–∂–∏, –∫–∞–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ —à–∫–æ–ª–µ –¥–∞—é—Ç—Å—è –ª–µ–≥–∫–æ? –ò —á–µ–º –æ–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è, –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –≤—Ä–µ–º—è?"

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
- –ù–µ –¥–∞–≤–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é —Å—Ä–∞–∑—É ‚Äî —Å–Ω–∞—á–∞–ª–∞ —É–∑–Ω–∞–π —á–µ–ª–æ–≤–µ–∫–∞
- –ü—Ä–µ–¥–ª–∞–≥–∞–π 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π, –Ω–µ –æ–¥–∏–Ω
- –ö –∫–∞–∂–¥–æ–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –¥–æ–±–∞–≤–ª—è–π: –∑–∞—Ä–ø–ª–∞—Ç–∞, –ø–ª—é—Å—ã/–º–∏–Ω—É—Å—ã
- –ü–æ—Å–ª–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏ –í–°–ï–ì–î–ê –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤—É–∑—ã –∏–∑ –±–∞–∑—ã
- –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏, —Å–∫–∞–∂–∏ —á—Ç–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- –ú–æ–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º, –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º

–§–û–†–ú–ê–¢ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–†–û–§–ï–°–°–ò–ò:
üéØ **[–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏]**
- –ß–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è: ...
- –ó–∞—Ä–ø–ª–∞—Ç–∞ –≤ –ö–ó: –æ—Ç ... –¥–æ ... —Ç–≥
- –ü–ª—é—Å—ã: ...
- –ú–∏–Ω—É—Å—ã: ...
- –ì–¥–µ —É—á–∏—Ç—å—Å—è: [–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ã –∏–∑ –±–∞–∑—ã]

–ù–∞—á–Ω–∏ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –æ —á–µ–ª–æ–≤–µ–∫–µ!"""
            
            contents = []
            
            contents.append({
                "role": "user",
                "parts": [{"text": system_context}]
            })
            contents.append({
                "role": "model", 
                "parts": [{"text": "–ü—Ä–∏–≤–µ—Ç! üëã –Ø Edu Hub AI ‚Äî –ø–æ–º–æ–≥—É –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é —Ç–≤–æ–µ–π –º–µ—á—Ç—ã –∏ –ø–æ–¥—Å–∫–∞–∂—É, –≥–¥–µ —É—á–∏—Ç—å—Å—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ!\n\n–†–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ: –∫–∞–∫–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ —à–∫–æ–ª–µ —Ç–µ–±–µ –Ω—Ä–∞–≤—è—Ç—Å—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ? üìö"}]
            })
            
            for msg in conversation_history:
                role = "user" if msg.get('role') == 'user' else "model"
                contents.append({
                    "role": role,
                    "parts": [{"text": msg.get('content', '')}]
                })
            
            contents.append({
                "role": "user",
                "parts": [{"text": user_message}]
            })
            
            payload = {"contents": contents}
            
            response = requests.post(GEMINI_API_URL, json=payload, headers={'Content-Type': 'application/json'})
            
            if response.status_code == 200:
                result = response.json()
                ai_response = result['candidates'][0]['content']['parts'][0]['text']
                return JsonResponse({'response': ai_response})
            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code} - {response.text[:300]}")
                return JsonResponse({'response': '–£–ø—Å, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑! üîÑ'}, status=500)
                
        except Exception as e:
            print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)}")
            return JsonResponse({'response': f'–û—à–∏–±–∫–∞: {str(e)}'}, status=500)
    
    return JsonResponse({'error': '–ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}, status=405)
