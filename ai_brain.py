import requests
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json
import os


# –ó–∞–≥—Ä—É–∂–∞–µ–º API –∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞ keys.env
def load_api_key():
    env_path = os.path.join(os.path.dirname(__file__), 'keys.env')
    try:
        with open(env_path, 'r') as f:
            for line in f:
                if line.startswith('gemini_api_key='):
                    return line.strip().split('=', 1)[1]
    except FileNotFoundError:
        print("‚ùå –§–∞–π–ª keys.env –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    return None

API_KEY = load_api_key()
if API_KEY:
    print(f"‚úÖ API –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω")
else:
    print("‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ keys.env!")
    
GEMINI_API_URL = f'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key={API_KEY}'

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ü–û–õ–ù–£–Æ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –¢—É—Ä–∞–Ω
KNOWLEDGE_BASE = ""
knowledge_file_path = os.path.join(os.path.dirname(__file__), 'turan_university_knowledge.txt')
try:
    with open(knowledge_file_path, 'r', encoding='utf-8') as f:
        KNOWLEDGE_BASE = f.read()
    print(f"‚úÖ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω–∞: {len(KNOWLEDGE_BASE)} —Å–∏–º–≤–æ–ª–æ–≤")
except FileNotFoundError:
    print("‚ùå –§–∞–π–ª turan_university_knowledge.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    KNOWLEDGE_BASE = "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."


@csrf_exempt
def ai_chat(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
            user_message = data.get('message', '')
            conversation_history = data.get('history', [])  # –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –ø–æ–ª–Ω–æ–π –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π
            system_context = f"""–¢—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ ¬´–¢—É—Ä–∞–Ω¬ª (–ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω). –¢–µ–±—è –∑–æ–≤—É—Ç –¢—É—Ä–∞–Ω-–±–æ—Ç! üéì

–¢–í–û–Ø –õ–ò–ß–ù–û–°–¢–¨:
- –¢—ã –æ–±—â–∏—Ç–µ–ª—å–Ω—ã–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫
- –ì–æ–≤–æ—Ä–∏—à—å –∫–∞–∫ –¥—Ä—É–≥, –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—Å—è –≤ —É–Ω–∏–≤–µ—Ä–µ –∏ –≤—Å—ë –∑–Ω–∞–µ—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å –∂–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫, –Ω–æ –±–µ–∑ —Å–ª–µ–Ω–≥–∞
- –ú–æ–∂–µ—à—å —à—É—Ç–∏—Ç—å, –Ω–æ –≤ –º–µ—Ä—É –∏ —É–º–µ—Å—Ç–Ω–æ
- –¢—ã —ç–Ω—Ç—É–∑–∏–∞—Å—Ç —Å–≤–æ–µ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–π

–ö–ê–ö –û–¢–í–ï–ß–ê–¢–¨:
1. –ù–ï –∫–æ–ø–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –¥–æ—Å–ª–æ–≤–Ω–æ ‚Äî –ø–µ—Ä–µ—Å–∫–∞–∂–∏ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏
2. –î–æ–±–∞–≤–ª—è–π –ø–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ("–≠—Ç–æ –∫—Ä—É—Ç–∞—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å!", "–ú–Ω–æ–≥–∏–µ –≤—ã–±–∏—Ä–∞—é—Ç –∏–º–µ–Ω–Ω–æ —ç—Ç—É –ø—Ä–æ–≥—Ä–∞–º–º—É")
3. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –∑–∞—Ä–ø–ª–∞—Ç–∞—Ö ‚Äî –º–æ–∂–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å "–Ω–æ —ç—Ç–æ —Å—Ä–µ–¥–Ω–∏–µ —Ü–∏—Ñ—Ä—ã, —Ç–æ–ø–æ–≤—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –±–æ–ª—å—à–µ!"
4. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π üòä
5. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã ‚Äî —Å–ø–∏—Å–∫–∏, –∞–±–∑–∞—Ü—ã, –Ω–æ –Ω–µ –∫–∞–∫ —Ä–æ–±–æ—Ç
6. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π ‚Äî –æ—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, –µ—Å–ª–∏ —Å–ª–æ–∂–Ω—ã–π ‚Äî —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ

–ü–†–ò–ú–ï–†–´ –û–ñ–ò–í–õ–ï–ù–ò–Ø:
‚ùå –ü–ª–æ—Ö–æ: "–°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 1 300 000 —Ç–µ–Ω–≥–µ –≤ –≥–æ–¥"
‚úÖ –•–æ—Ä–æ—à–æ: "IT —É –Ω–∞—Å —Å—Ç–æ–∏—Ç 1 300 000 —Ç–≥ –≤ –≥–æ–¥ ‚Äî —ç—Ç–æ —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –¥–ª—è –∞–π—Ç–∏—à–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–µ–π –≤ –ê–ª–º–∞—Ç—ã. –ö—Å—Ç–∞—Ç–∏, –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–ª—É—á–∏—Ç—å –≥—Ä–∞–Ω—Ç –∏–ª–∏ —Å–∫–∏–¥–∫—É! üíª"

‚ùå –ü–ª–æ—Ö–æ: "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –¢—É—Ä–∞–Ω –∑–∞–Ω–∏–º–∞–µ—Ç 6 –º–µ—Å—Ç–æ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ"
‚úÖ –•–æ—Ä–æ—à–æ: "–ú—ã –≤ —Ç–æ–ø-6 –≤—É–∑–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞! üèÜ –ê –ø–æ —ç–∫–æ–Ω–æ–º–∏–∫–µ –∏ MBA –≤–æ–æ–±—â–µ –ø–µ—Ä–≤—ã–µ ‚Äî —ç—Ç–∏–º —Ä–µ–∞–ª—å–Ω–æ –≥–æ—Ä–¥–∏–º—Å—è"

–û–°–û–ë–´–ï –°–õ–£–ß–ê–ò:
- –ï—Å–ª–∏ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è ‚Äî –ø–æ–¥–±–æ–¥—Ä–∏, —Ä–∞—Å—Å–∫–∞–∂–∏ –æ –ø–ª—é—Å–∞—Ö
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–∫—É–¥–∞ –ª—É—á—à–µ –ø–æ—Å—Ç—É–ø–∏—Ç—å" ‚Äî –Ω–µ –Ω–∞–≤—è–∑—ã–≤–∞–π, –¥–∞–π –æ–±—ä–µ–∫—Ç–∏–≤–Ω—É—é –∏–Ω—Ñ—É
- –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ ‚Äî —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –∏ –¥–∞–π –∫–æ–Ω—Ç–∞–∫—Ç –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ —É–Ω–∏–≤–µ—Ä ‚Äî –º—è–≥–∫–æ –≤–µ—Ä–Ω–∏ –∫ —Ç–µ–º–µ ("–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ –¢—É—Ä–∞–Ω–µ, –Ω–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∏–Ω—Ñ–∞ –æ–± —É–Ω–∏–≤–µ—Ä–µ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π!")

–ö–û–ù–¢–ï–ö–°–¢ –†–ê–ó–ì–û–í–û–†–ê:
- –ó–∞–ø–æ–º–∏–Ω–∞–π –∏–º—è, –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è
- –ü–æ–º–Ω–∏ –∫–∞–∫—É—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –æ–±—Å—É–∂–¥–∞–ª–∏
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç "–∞ —Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å—Ç–æ–∏—Ç?" ‚Äî –ø–æ–π–º–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ —á—ë–º —Ä–µ—á—å

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–∏—Å–ø–æ–ª—å–∑—É–π –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ —Ñ–∞–∫—Ç–æ–≤, –Ω–æ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏):
{KNOWLEDGE_BASE}

–í–ê–ñ–ù–û: –í—Å–µ —Ü–∏—Ñ—Ä—ã, —Ç–µ–ª–µ—Ñ–æ–Ω—ã –∏ —Ñ–∞–∫—Ç—ã –±–µ—Ä–∏ –¢–û–õ–¨–ö–û –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π ‚Äî –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π!"""
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è Gemini
            contents = []
            
            # –°–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞–∫ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            contents.append({
                "role": "user",
                "parts": [{"text": system_context}]
            })
            contents.append({
                "role": "model",
                "parts": [{"text": "–ü—Ä–∏–≤–µ—Ç! üëã –Ø –¢—É—Ä–∞–Ω-–±–æ—Ç ‚Äî —Ç–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–± —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –¢—É—Ä–∞–Ω. –°–ø—Ä–∞—à–∏–≤–∞–π —á—Ç–æ —É–≥–æ–¥–Ω–æ: –ø—Ä–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏, —Ü–µ–Ω—ã, –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –æ–±—â–∞–≥—É ‚Äî –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è! –ö—Å—Ç–∞—Ç–∏, –º–æ–∂–µ—à—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è, —Ç–∞–∫ –±—É–¥–µ—Ç –ø—Ä–∏—è—Ç–Ω–µ–µ –æ–±—â–∞—Ç—å—Å—è üòä"}]
            })
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            for msg in conversation_history:
                role = "user" if msg.get('role') == 'user' else "model"
                contents.append({
                    "role": role,
                    "parts": [{"text": msg.get('content', '')}]
                })
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            contents.append({
                "role": "user",
                "parts": [{"text": user_message}]
            })
            
            # –ó–∞–ø—Ä–æ—Å –∫ Gemini API —Å –∏—Å—Ç–æ—Ä–∏–µ–π
            payload = {
                "contents": contents
            }
            
            print(f"üîë –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π URL: {GEMINI_API_URL[:80]}...")
            response = requests.post(GEMINI_API_URL, json=payload, headers={'Content-Type': 'application/json'})
            
            print(f"üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: {response.status_code}")
            if response.status_code != 200:
                print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.text[:500]}")
            
            if response.status_code == 200:
                result = response.json()
                ai_response = result['candidates'][0]['content']['parts'][0]['text']
                return JsonResponse({'response': ai_response})
            else:
                return JsonResponse({'response': f'–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ö–æ–¥: {response.status_code}'}, status=500)
                
        except Exception as e:
            print(f"‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: {str(e)}")
            return JsonResponse({'response': f'–û—à–∏–±–∫–∞: {str(e)}'}, status=500)
    
    return JsonResponse({'error': '–ú–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'}, status=405)
